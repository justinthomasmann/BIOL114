---
title: "SimTest2"
author: "Justin Mann"
date: "2023-10-04"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
library(shiny)

ui <- fluidPage(
  numericInput("camiPop", "Enter starting Caminalcule population (1-100):", min = 1, max = 100, value = 1),
  numericInput("pollPop", "Enter starting Pollard population (1-75):", min = 1, max = 75, value = 1),
  numericInput("camiPopMultiply", "Enter Caminalcule Reproduction rate (1-10):", min = 1, max = 10, value = 1),
  numericInput("numGenerations", "Enter the number of generations to simulate (1-100):", min = 1, max = 100, value = 1),
  checkboxInput("printArray", "Display a population array after each generation", value = FALSE),
  checkboxInput("printLocations", "Display coordinates for Caminalcule and Pollards each generation", value = FALSE),
  actionButton("simulateButton", "Simulate"),
  verbatimTextOutput("simulationOutput")
)

server <- function(input, output, session) {
   # Define reactive values to store camiPop and pollPop
  camiPop <- reactiveVal()
  pollPop <- reactiveVal()
  
  observeEvent(input$simulateButton, {
    camiPop <- input$camiPop
    pollPop <- input$pollPop
    camiPopMultiply <- input$camiPopMultiply
    numGenerations <- input$numGenerations
    printArray <- input$printArray
    printLocations <- input$printLocations
    
    simulationOutput <- isolate({beginSim <- function(camiPop, pollPop, camiPopMultiply, numGenerations, printArray, printLocations) {
  cat(sprintf("Gen: 0 Starting Caminalcule Pop: %d Starting Pollard Pop: %d\n", camiPop, pollPop))
  
  for (index in 1:numGenerations) {
    found <- 0
    biome <- matrix(FALSE, nrow = 10, ncol = 10)
    
    for (cami in 1:camiPop) {
      x <- sample(1:10, 1)
      y <- sample(1:10, 1)
      
      if (!biome[x, y]) {
        biome[x, y] <- TRUE
      } else {
        while (biome[x, y]) {
          x <- sample(1:10, 1)
          y <- sample(1:10, 1)
        }
        biome[x, y] <- TRUE
      }
    }
    
    chosenXY <- matrix(FALSE, nrow = 10, ncol = 10)
    
    for (polly in 1:pollPop) {
      x <- sample(1:10, 1)
      y <- sample(1:10, 1)
      
      while (chosenXY[x, y]) {
        x <- sample(1:10, 1)
        y <- sample(1:10, 1)
      }
      
      if (biome[x, y] && !chosenXY[x, y]) {
        camiPop <- camiPop - 1
        found <- found + 1
        chosenXY[x, y] <- TRUE
      } else {
        chosenXY[x, y] <- TRUE
      }
    }
    
    camiPop <- camiPop * camiPopMultiply
    if (camiPop < 1) camiPop <- 1
    if (camiPop > 100) camiPop <- 100
    
    lostPop <- floor(pollPop / 3)
    pollPop <- pollPop - lostPop
    pollPop <- pollPop + found + 1
    
    if (pollPop > 75) pollPop <- 75
    if (pollPop < 1) pollPop <- 1
    
    cat(sprintf("Gen: %d Ending Caminalcule Pop: %d Ending Pollard Pop: %d || found: %d\n", index, camiPop, pollPop, found))
    if (printArray) printBiome(biome, chosenXY)
    if (printLocations) printCoordinates(biome, chosenXY)
  }
}

camiPop <- -1
pollPop <- -1
camiPopMultiply <- -1
numGenerations <- -1
printArray <- FALSE
printLocations <- FALSE
     
      result <- capture.output({
        beginSim(camiPop, pollPop, camiPopMultiply, numGenerations, printArray, printLocations)
      })
      paste(result, collapse = "\n")
    })
    
    output$simulationOutput <- renderPrint({
      renderPrint(simulationOutput)
    })
  })
}

shinyApp(ui, server)
```

